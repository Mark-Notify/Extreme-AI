<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Extreme AI v4 – Trading Desk</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Google Font: Roboto (Material UI feeling) -->
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;600;700&display=swap" rel="stylesheet"/>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --primary: #5b3cc4;
      --primary-soft: rgba(91, 60, 196, 0.08);
      --primary-strong: #4c32a5;

      --accent-gold: #f5b400;
      --accent-soft: rgba(245, 180, 0, 0.14);

      --success: #16a34a;
      --success-soft: rgba(22, 163, 74, 0.1);

      --danger: #ef4444;
      --danger-soft: rgba(239, 68, 68, 0.12);

      --surface: #ffffff;
      --surface-alt: #f9fafb;
      --border-subtle: #e5e7eb;
      --border-strong: #d1d5db;

      --chip-bg: #f3f4ff;
      --text-main: #111827;
      --text-muted: #6b7280;
      --text-soft: #9ca3af;
    }

    body {
      min-height: 100vh;
      margin: 0;
      background:
        radial-gradient(circle at 0% 0%, rgba(91, 60, 196, 0.16), transparent 55%),
        radial-gradient(circle at 100% 0%, rgba(245, 180, 0, 0.16), transparent 55%),
        linear-gradient(to bottom, #f5f5fb, #f9fafb);
      font-family: "Roboto", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: var(--text-main);
    }

    .card {
      background: var(--surface);
      border-radius: 18px;
      border: 1px solid var(--border-subtle);
      box-shadow:
        0 10px 30px rgba(15, 23, 42, 0.06),
        0 1px 2px rgba(15, 23, 42, 0.03);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 0.3rem;
      border-radius: 999px;
      padding: 0.18rem 0.7rem;
      font-size: 0.7rem;
      font-weight: 500;
      background-color: var(--chip-bg);
      border: 1px solid rgba(129, 140, 248, 0.5);
      color: #4338ca;
      /* letter-spacing: 0.08em; */
      text-transform: uppercase;
    }

    .pill-soft {
      background-color: #eef2ff;
      border-color: #e0e7ff;
      color: #4f46e5;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
      border-radius: 999px;
      padding: 0.55rem 1.25rem;
      font-size: 0.8rem;
      font-weight: 500;
      border: 1px solid transparent;
      cursor: pointer;
      transition:
        transform 0.08s ease,
        box-shadow 0.1s ease,
        background 0.16s ease,
        border-color 0.16s ease,
        color 0.16s ease;
      white-space: nowrap;
    }

    .btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: none;
    }

    .btn:disabled {
      opacity: 0.55;
      cursor: default;
      transform: none;
      box-shadow: none;
    }

    .btn-primary {
      background:
        radial-gradient(circle at 0 -40%, rgba(255, 255, 255, 0.7), transparent 60%),
        linear-gradient(135deg, #7c3aed, var(--primary));
      color: #f9fafb;
      border-color: #7c3aed;
      box-shadow:
        0 4px 14px rgba(91, 60, 196, 0.4),
        0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .btn-primary:hover:not(:disabled) {
      background: linear-gradient(135deg, var(--primary), var(--primary-strong));
    }

    .btn-danger {
      background:
        radial-gradient(circle at 0 -40%, rgba(255, 255, 255, 0.7), transparent 60%),
        linear-gradient(135deg, #fb7185, #ef4444);
      color: #fff1f2;
      border-color: #fb7185;
      box-shadow:
        0 4px 14px rgba(248, 113, 113, 0.4),
        0 1px 3px rgba(0, 0, 0, 0.08);
    }

    .btn-danger:hover:not(:disabled) {
      background: linear-gradient(135deg, #ef4444, #fecaca);
    }

    .btn-soft {
      background: var(--surface-alt);
      color: var(--text-main);
      border-color: var(--border-subtle);
      box-shadow:
        0 2px 8px rgba(15, 23, 42, 0.04),
        0 1px 2px rgba(15, 23, 42, 0.03);
    }

    .btn-soft:hover:not(:disabled) {
      background: #eef2ff;
      border-color: #c7d2fe;
    }

    .status-dot {
      height: 10px;
      width: 10px;
      border-radius: 999px;
      box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.35);
      transition:
        background 0.16s ease,
        box-shadow 0.16s ease,
        transform 0.16s ease;
    }
    .status-online {
      background: #22c55e;
      box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.25);
    }
    .status-offline {
      background: #ef4444;
      box-shadow: 0 0 0 6px rgba(239, 68, 68, 0.25);
    }

    .gauge-ring {
      transition: stroke-dashoffset 0.4s ease-out;
    }

    .direction-badge {
      background-color: #eef2ff;
      border-radius: 999px;
      border: 1px solid #c7d2fe;
      padding: 0.16rem 0.75rem;
      font-size: 0.7rem;
      font-weight: 500;
      letter-spacing: 0.16em;
      text-transform: uppercase;
      color: #4338ca;
    }

    .badge-bull {
      border-color: #86efac;
      background-color: #ecfdf3;
      color: #15803d;
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.35);
    }

    .badge-bear {
      border-color: #fecaca;
      background-color: #fef2f2;
      color: #b91c1c;
      box-shadow: 0 0 0 1px rgba(248, 113, 113, 0.35);
    }

    .badge-pre-active {
      background: #fef3c7;
      border-color: #facc15;
      color: #b45309;
    }

    .badge-confirm-active {
      background: var(--accent-soft);
      border-color: var(--accent-gold);
      color: #92400e;
    }

    .fade-item {
      opacity: 0;
      transform: translateY(2px);
    }

    .fade-item.show {
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.18s ease-out, transform 0.18s ease-out;
    }

    #rawState {
      background: #f9fafb;
      border-radius: 16px;
      border: 1px solid #e5e7eb;
      box-shadow: inset 0 0 0 1px #e5e7eb;
      color: #111827;
    }

    body #gaugeGradient stop:nth-of-type(1) { stop-color: #7c3aed; }
    body #gaugeGradient stop:nth-of-type(2) { stop-color: #f59e0b; }
    body #gaugeGradient stop:nth-of-type(3) { stop-color: #ec4899; }

    /* Small metric label */
    .metric-label {
      font-size: 0.7rem;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: var(--text-soft);
    }
  </style>
</head>
<body class="text-slate-900">
  <!-- Top bar -->
  <header class="border-b border-slate-200 bg-white/90 backdrop-blur-xl sticky top-0 z-30 shadow-sm">
    <div class="max-w-6xl mx-auto px-4 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <div class="h-9 w-9 rounded-2xl bg-gradient-to-br from-indigo-500 via-purple-500 to-amber-400 border border-indigo-200 flex items-center justify-center shadow-md shadow-indigo-400/40">
          <span class="text-[11px] font-semibold tracking-[0.22em] text-white">XA</span>
        </div>
        <div>
          <div class="flex flex-wrap items-center gap-2">
            <h1 class="text-sm md:text-base font-semibold tracking-wide text-slate-900">
              Extreme AI v4 <span class="text-slate-500">Trading Desk</span>
            </h1>
            <span id="engineModeBadge"
                  class="pill">
              Engine: <span id="engineModeText">RULE</span>
            </span>
          </div>
          <p class="text-[11px] text-slate-500 mt-0.5">
            XAUUSD · Extreme AI Engine · Live Monitor
          </p>
        </div>
      </div>

      <div class="flex items-center gap-4 text-xs">
        <div class="hidden sm:flex flex-col items-end">
          <span class="text-[11px] text-slate-400">Last loop</span>
          <span id="loopTime" class="font-mono text-[11px] text-slate-700">-</span>
        </div>
        <div class="flex items-center gap-2">
          <span id="wsDot" class="status-dot status-online"></span>
          <span id="wsStatusText" class="text-[11px] text-slate-600">Live</span>
        </div>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-6xl mx-auto px-4 py-4 md:py-6 space-y-4 md:space-y-6">
    <div class="grid grid-cols-1 xl:grid-cols-[minmax(0,2.2fr)_minmax(0,1.2fr)] gap-4 md:gap-6">
      <!-- Left column -->
      <section class="space-y-4 md:space-y-6">
        <!-- Market overview card -->
        <div class="card px-4 py-4 md:px-5 md:py-5">
          <div class="flex items-start justify-between gap-4 mb-4">
            <div>
              <p class="metric-label">Instrument</p>
              <div class="flex items-baseline gap-2 mt-1">
                <h2 id="symbol" class="text-lg md:text-xl font-semibold tracking-tight text-slate-900">XAUUSD</h2>
                <span class="pill pill-soft text-[11px]">
                  TF <span id="timeframe" class="font-mono text-slate-800">M1</span>
                </span>
              </div>
            </div>
            <div class="text-right space-y-1">
              <div>
                <p class="metric-label">Open Trades</p>
                <p id="openTrades" class="font-mono text-lg text-slate-900">0</p>
              </div>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-[minmax(0,1.1fr)_minmax(0,1fr)] gap-4 md:gap-6 items-center">
            <div class="space-y-4">
              <div>
                <p class="metric-label">Last price</p>
                <div class="flex items-baseline gap-2 mt-1">
                  <span id="price" class="text-3xl font-semibold tracking-tight text-slate-900">-</span>
                  <span id="priceDirectionBadge"
                        class="direction-badge text-[11px]">
                    -
                  </span>
                </div>
              </div>

              <div class="grid grid-cols-2 sm:grid-cols-4 gap-3 text-[11px]">
                <div>
                  <p class="text-slate-400 mb-0.5">Regime</p>
                  <p id="regime" class="text-slate-800">-</p>
                </div>
                <div>
                  <p class="text-slate-400 mb-0.5">RSI</p>
                  <p class="text-slate-800">
                    <span id="rsi">-</span>
                    <span class="text-slate-400">(<span id="rsiZone">-</span>)</span>
                  </p>
                </div>
                <div>
                  <p class="text-slate-400 mb-0.5">ADX</p>
                  <p id="adx" class="text-slate-800">-</p>
                </div>
                <div>
                  <p class="text-slate-400 mb-0.5">MACD Hist</p>
                  <p id="macdHist" class="font-mono text-xs text-slate-800">-</p>
                </div>
              </div>
            </div>

            <!-- AI gauge quick glance -->
            <div class="card border-none shadow-none bg-surface-alt px-4 py-3">
              <div class="flex items-center justify-between">
                <p class="metric-label">AI Outlook</p>
                <span id="aiDirectionLabel" class="text-[11px] font-medium text-indigo-600">
                  -
                </span>
              </div>
              <div class="relative mx-auto w-40 h-24 mt-2">
                <svg viewBox="0 0 120 70" class="w-full h-full">
                  <path
                    d="M10 60 A 50 50 0 0 1 110 60"
                    fill="none"
                    stroke="#e5e7eb"
                    stroke-width="9"
                    stroke-linecap="round"
                  ></path>
                  <path
                    id="gaugeArc"
                    d="M10 60 A 50 50 0 0 1 110 60"
                    fill="none"
                    stroke="url(#gaugeGradient)"
                    stroke-width="9"
                    stroke-linecap="round"
                    stroke-dasharray="157"
                    stroke-dashoffset="78"
                    class="gauge-ring"
                  ></path>
                  <defs>
                    <linearGradient id="gaugeGradient" x1="0%" y1="0%" x2="100%" y2="0%">
                      <stop offset="0%" stop-color="#7c3aed" />
                      <stop offset="50%" stop-color="#f59e0b" />
                      <stop offset="100%" stop-color="#ec4899" />
                    </linearGradient>
                  </defs>
                </svg>
                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                  <div id="aiProbUp" class="text-xl font-semibold text-slate-900">-</div>
                  <div class="text-[11px] text-slate-500">Prob. UP</div>
                  <div id="aiConfidence" class="mt-1 text-[11px] text-slate-500">
                    Conf: -
                  </div>
                </div>
              </div>
              <div class="mt-1 flex items-center justify-between text-[10px] text-slate-400">
                <span>0%</span><span>50%</span><span>100%</span>
              </div>
              <div class="mt-3 grid grid-cols-2 gap-3 text-[11px]">
                <div>
                  <p class="text-slate-400 mb-0.5">ATR</p>
                  <p id="atr" class="font-mono text-xs text-slate-800">-</p>
                </div>
                <div class="flex items-center justify-between">
                  <span class="text-slate-400">Engine</span>
                  <span id="useLstmTag" class="pill">
                    RULE-ONLY
                  </span>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Signals + Trade Center row -->
        <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,1.2fr)_minmax(0,1.1fr)] gap-4 md:gap-6">
          <!-- Signals -->
          <div class="card px-4 py-4 md:px-5 md:py-5">
            <div class="flex items-center justify-between mb-3">
              <p class="metric-label">Signals</p>
              <div class="flex flex-wrap items-center gap-2 text-[11px]">
                <span id="preSignalBadge" class="pill">
                  PRE: <span id="preSignalText">None</span>
                </span>
                <span id="confirmSignalBadge" class="pill">
                  CONFIRM: <span id="confirmSignalText">None</span>
                </span>
              </div>
            </div>

            <div class="mt-2">
              <p class="text-[11px] text-slate-400 mb-1.5">Recent signals</p>
              <ul id="signalTimeline"
                  class="space-y-1 text-[11px] max-h-40 overflow-y-auto pr-1">
                <!-- timeline items via JS -->
              </ul>
            </div>
          </div>

          <!-- Trade Center -->
          <div class="card px-4 py-4 md:px-5 md:py-5">
            <div class="flex items-center justify-between mb-4">
              <div>
                <p class="metric-label">Trade Center</p>
                <p class="text-[11px] text-slate-500 mt-1">
                  Manual & AI-assisted routing → MT5
                </p>
              </div>
            </div>

            <div class="space-y-4">
              <div class="grid grid-cols-3 gap-2">
                <button id="btnBuy" class="btn btn-primary">
                  BUY
                </button>
                <button id="btnSell" class="btn btn-danger">
                  SELL
                </button>
                <button id="btnAuto" class="btn btn-soft">
                  AUTO (AI)
                </button>
              </div>
              <p class="text-[11px] text-slate-500 leading-relaxed">
                • AUTO เลือก BUY/SELL จาก AI Prob ล่าสุด<br />
                • Volume ใช้ค่าจาก <span class="font-mono">MANUAL_TRADE_VOLUME</span>
              </p>

              <div class="border border-slate-200 rounded-xl px-3 py-3 bg-slate-50 space-y-2">
                <div class="flex items-center justify-between">
                  <p class="text-[11px] text-slate-500">Training LSTM</p>
                  <button id="btnTrain" class="btn btn-soft px-3 py-1.5 text-xs">
                    Train AI
                  </button>
                </div>
                <p class="text-[11px] text-slate-500">
                  ฝึกโมเดลจาก <span class="font-mono">logs/ai_log.jsonl</span> เมื่อเทรนสำเร็จระบบจะใช้ LSTM อัตโนมัติ
                </p>
                <p id="trainStatus" class="text-[11px] text-slate-500">
                  Status: idle
                </p>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right column -->
      <aside class="space-y-4 md:space-y-6">
        <div class="card px-4 py-4 md:px-5 md:py-5 flex flex-col min-h-[260px]">
          <div class="flex items-center justify-between mb-2">
            <p class="metric-label">AI Snapshot (JSON)</p>
            <button id="btnToggleJson"
                    class="text-[11px] text-slate-500 hover:text-slate-700">
              Hide
            </button>
          </div>
          <pre id="rawState"
               class="mt-2 text-[11px] leading-relaxed font-mono flex-1 overflow-auto whitespace-pre-wrap">
-
          </pre>
        </div>
      </aside>
    </div>
  </main>

  <script>
    const $ = (id) => document.getElementById(id);

    // ---- signal timeline ----
    const signalTimeline = [];
    const maxSignals = 20;

    function pushSignal(text, type) {
      const ts = new Date().toLocaleTimeString();
      const label = type === "CONFIRM" ? "CONFIRM" : "PRE";
      signalTimeline.unshift({ ts, text, label, type });
      if (signalTimeline.length > maxSignals) signalTimeline.pop();
      renderSignalTimeline();
    }

    function renderSignalTimeline() {
      const ul = $("signalTimeline");
      ul.innerHTML = "";
      signalTimeline.forEach((s) => {
        const li = document.createElement("li");
        li.className = "fade-item";
        const color =
          s.type === "CONFIRM" ? "text-emerald-600" : "text-amber-600";
        li.innerHTML = `
          <span class="text-slate-400 mr-1">${s.ts}</span>
          <span class="${color} font-semibold mr-1">${s.label}</span>
          <span class="text-slate-700">${s.text}</span>
        `;
        ul.appendChild(li);
        requestAnimationFrame(() => li.classList.add("show"));
      });
    }

    // ---- status / gauge ----
    function setWsStatus(online) {
      const dot = $("wsDot");
      const txt = $("wsStatusText");
      if (online) {
        dot.classList.remove("status-offline");
        dot.classList.add("status-online");
        txt.textContent = "Live";
      } else {
        dot.classList.remove("status-online");
        dot.classList.add("status-offline");
        txt.textContent = "Disconnected";
      }
    }

    function updateGauge(probUp) {
      const arc = $("gaugeArc");
      const circ = 157;
      const value = Math.max(0, Math.min(1, probUp ?? 0.5));
      const offset = circ - circ * value;
      arc.style.strokeDashoffset = offset;
    }

    // ---- main dashboard update ----
    function updateDashboard(state) {
      if (!state || Object.keys(state).length === 0) return;

      $("loopTime").textContent = state.loop_started ? new Date(state.loop_started).toLocaleString() : "-";
      $("symbol").textContent = state.symbol || "XAUUSD";
      $("price").textContent =
        state.price !== undefined ? state.price.toFixed(2) : "-";
      $("openTrades").textContent = state.open_trades ?? 0;

      $("rsi").textContent =
        state.rsi !== undefined ? state.rsi.toFixed(2) : "-";
      $("rsiZone").textContent = state.rsi_zone || "-";
      $("macdHist").textContent =
        state.macd_hist !== undefined ? state.macd_hist.toFixed(4) : "-";
      $("atr").textContent =
        state.atr !== undefined ? state.atr.toFixed(3) : "-";
      $("adx").textContent =
        state.adx !== undefined ? state.adx.toFixed(2) : "-";
      $("regime").textContent = state.regime || "-";

      const probUp = state.ai_prob_up ?? 0.5;
      const conf = state.ai_confidence ?? 0;

      $("aiProbUp").textContent = (probUp * 100).toFixed(1) + "%";
      $("aiConfidence").textContent =
        "Conf: " + (conf * 100).toFixed(0) + "%";
      updateGauge(probUp);

      const dir = state.ai_direction || (probUp >= 0.5 ? "UP" : "DOWN");
      $("aiDirectionLabel").textContent =
        dir === "UP" ? "Bias: Long" : "Bias: Short";

      // price badge
      const badge = $("priceDirectionBadge");
      badge.textContent = dir;
      badge.classList.remove("badge-bull", "badge-bear");
      if (dir === "UP") {
        badge.classList.add("badge-bull");
      } else {
        badge.classList.add("badge-bear");
      }

      // engine mode / LSTM
      const useLstm = !!state.use_lstm;
      const engineBadge = $("engineModeBadge");
      const engineText = $("engineModeText");
      const useLstmTag = $("useLstmTag");

      if (useLstm) {
        engineText.textContent = "LSTM";
        useLstmTag.textContent = "LSTM + RULE";
        engineBadge.style.backgroundColor = "var(--accent-soft)";
        engineBadge.style.borderColor = "var(--accent-gold)";
        engineBadge.style.color = "#92400e";
      } else {
        engineText.textContent = "RULE";
        useLstmTag.textContent = "RULE-ONLY";
        engineBadge.style.backgroundColor = "var(--chip-bg)";
        engineBadge.style.borderColor = "rgba(129,140,248,0.5)";
        engineBadge.style.color = "#4338ca";
      }

      // signals
      const preBadge = $("preSignalBadge");
      const preText = $("preSignalText");
      preBadge.classList.remove("badge-pre-active");
      if (state.pre_signal) {
        preText.textContent = "Active";
        preBadge.classList.add("badge-pre-active");
        if (state.pre_timestamp) {
          pushSignal("PRE signal", "PRE");
        }
      } else {
        preText.textContent = "None";
      }

      const confBadge = $("confirmSignalBadge");
      const confText = $("confirmSignalText");
      confBadge.classList.remove("badge-confirm-active");
      if (state.confirm_signal) {
        confText.textContent = "Active";
        confBadge.classList.add("badge-confirm-active");
        if (state.confirm_timestamp) {
          pushSignal("CONFIRM " + dir, "CONFIRM");
        }
      } else {
        confText.textContent = "None";
      }

      $("rawState").textContent = JSON.stringify(state, null, 2);
    }

    // ---- WebSocket ----
    let ws;
    function connectWs() {
      const proto = location.protocol === "https:" ? "wss" : "ws";
      ws = new WebSocket(`${proto}://${location.host}/ws`);

      ws.onopen = () => setWsStatus(true);
      ws.onclose = () => {
        setWsStatus(false);
        setTimeout(connectWs, 2000);
      };
      ws.onerror = () => setWsStatus(false);
      ws.onmessage = (event) => {
        try {
          const data = JSON.parse(event.data);
          updateDashboard(data);
        } catch (e) {
          console.error("WS parse error", e);
        }
      };
    }
    connectWs();

    // ---- API helper ----
    async function postJson(url, body) {
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body ?? {}),
      });
      return res.json();
    }

    $("btnBuy").addEventListener("click", async () => {
      $("btnBuy").disabled = true;
      try {
        await postJson("/api/order", { side: "BUY" });
      } catch (e) {
        console.error(e);
      } finally {
        $("btnBuy").disabled = false;
      }
    });

    $("btnSell").addEventListener("click", async () => {
      $("btnSell").disabled = true;
      try {
        await postJson("/api/order", { side: "SELL" });
      } catch (e) {
        console.error(e);
      } finally {
        $("btnSell").disabled = false;
      }
    });

    $("btnAuto").addEventListener("click", async () => {
      $("btnAuto").disabled = true;
      try {
        await postJson("/api/order", { side: "AUTO" });
      } catch (e) {
        console.error(e);
      } finally {
        $("btnAuto").disabled = false;
      }
    });

    $("btnTrain").addEventListener("click", async () => {
      $("btnTrain").disabled = true;
      $("trainStatus").textContent = "Status: training...";
      try {
        await postJson("/api/train_ai", {});
        $("trainStatus").textContent = "Status: training started";
      } catch (e) {
        console.error(e);
        $("trainStatus").textContent = "Status: error starting training";
      } finally {
        setTimeout(() => {
          $("btnTrain").disabled = false;
        }, 1500);
      }
    });

    $("btnToggleJson").addEventListener("click", () => {
      const pre = $("rawState");
      const hidden = pre.classList.toggle("hidden");
      $("btnToggleJson").textContent = hidden ? "Show" : "Hide";
    });
  </script>
</body>
</html>
